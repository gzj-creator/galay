# AsyncQueue æ”¹è¿›æ–¹æ¡ˆæ‰§è¡ŒæŠ¥å‘Š

## ğŸ“Š æ‰§è¡Œæ€»ç»“

| æ–¹é¢ | ç»“æœ |
|------|------|
| AsyncQueueæ”¹è¿›å®ç° | âœ… å®Œæˆ |
| Wakerç®¡ç†ä¼˜åŒ– | âœ… å®Œæˆ |
| å¤šæ¶ˆè´¹è€…æ”¯æŒ | âœ… ä»£ç å®Œæˆ |
| **æµ‹è¯•ç»“æœ** | âŒ **é—®é¢˜ä»å­˜** |

## ğŸ”§ å®ç°çš„æ”¹è¿›

### 1. Wakerç®¡ç†ä»å•æŒ‡é’ˆæ”¹ä¸ºåˆ—è¡¨

**æ”¹è¿›å‰**ï¼š
```cpp
private:
    Waker* m_waiting_waker = nullptr;  // å•ä¸ªåŸå§‹æŒ‡é’ˆ âš ï¸
```

**æ”¹è¿›å**ï¼š
```cpp
private:
    std::list<std::shared_ptr<Waker>> m_waiting_wakers;  // å¤šæ¶ˆè´¹è€…åˆ—è¡¨ âœ…
```

**ä¼˜ç‚¹**ï¼š
- æ”¯æŒå¤šä¸ªå¹¶å‘æ¶ˆè´¹è€…
- ä½¿ç”¨ `shared_ptr` é¿å…æ‚¬å‚æŒ‡é’ˆ
- FIFO é¡ºåºå”¤é†’æ¶ˆè´¹è€…

### 2. Waker ç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ–°å¢æ–¹æ³•**ï¼š
```cpp
void addWaiter(std::shared_ptr<Waker> waker);      // æ¶ˆè´¹è€…å¼€å§‹ç­‰å¾…
void removeWaiter(std::shared_ptr<Waker> waker);   // æ¶ˆè´¹è€…åœæ­¢ç­‰å¾…
void wakeWaiters();                                 // å”¤é†’ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€… (FIFO)
```

### 3. ç®€åŒ–çš„ onSuspend é€»è¾‘

**æ”¹è¿›å‰**ï¼ˆå¤æ‚çš„åŒé‡æ£€æŸ¥ï¼‰ï¼š
```cpp
bool onSuspend(Waker waker) override {
    T out;
    if (m_queue->m_queue.try_dequeue(out)) {
        this->m_result = std::move(out);
        return false;  // âš ï¸ å¤æ‚çš„è¿”å›falseé€»è¾‘
    }
    m_waker_storage = std::make_shared<Waker>(std::move(waker));
    m_queue->setWaiter(m_waker_storage.get());  // âš ï¸ åŸå§‹æŒ‡é’ˆ
    return true;
}
```

**æ”¹è¿›å**ï¼ˆæ¸…æ™°çš„æŒ‚èµ·é€»è¾‘ï¼‰ï¼š
```cpp
bool onSuspend(Waker waker) override {
    m_waker_storage = std::make_shared<Waker>(std::move(waker));
    m_queue->addWaiter(m_waker_storage);  // âœ… shared_ptr
    return true;  // å§‹ç»ˆæŒ‚èµ·
}
```

## ğŸ“ˆ æµ‹è¯•ç»“æœå¯¹æ¯”

### æ”¹è¿›å‰ vs æ”¹è¿›å

| æµ‹è¯• | æ”¹è¿›å‰ | æ”¹è¿›å | å˜åŒ– |
|------|-------|-------|------|
| **Test 1** (å•ç”Ÿäº§è€…100k) | âœ… 0% é‡å¤ | âœ… 0% é‡å¤ | æ— å˜åŒ– âœ“ |
| **Test 2** (3ç”Ÿäº§Ã—10k) | âŒ 60% é‡å¤ | âŒ 60% é‡å¤ | **æ— æ”¹è¿› âœ—** |
| **Test 3** (4ç”Ÿäº§Ã—50k) | âŒ 73.5% é‡å¤ | âŒ 73.5% é‡å¤ | **æ— æ”¹è¿› âœ—** |

**å…³é”®å‘ç°**ï¼š
- âœ… æ”¹è¿›æ²¡æœ‰ç ´åå•ç”Ÿäº§è€…åœºæ™¯
- âŒ æ”¹è¿›**æ²¡æœ‰è§£å†³**å¤šç”Ÿäº§è€…ä¸‹çš„æ•°æ®é‡å¤é—®é¢˜
- é‡å¤ç‡ä¸æ”¹è¿›å‰å®Œå…¨ç›¸åŒ

## ğŸ” é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆæ”¹è¿›æ²¡æœ‰è§£å†³é—®é¢˜ï¼Ÿ

é—®é¢˜ä¸åœ¨ AsyncQueue çš„å®ç°ç»†èŠ‚ï¼Œè€Œåœ¨äº **galay æ¡†æ¶çš„ AsyncEvent/Waker æœºåˆ¶æœ¬èº«**ã€‚

#### é—®é¢˜ 1: AsyncEvent æ¡†æ¶çš„è¡Œä¸ºä¸ç¡®å®š

å½“ `onReady()` è¿”å› `false` æ—¶ï¼ŒAsyncEvent æ¡†æ¶å¯èƒ½ï¼š

**è·¯å¾„A**ï¼ˆæœŸæœ›ï¼‰ï¼š
```
onReady() â†’ false
onSuspend() â†’ true  (suspend)
[ç­‰å¾… wakeUp()]
onResume() â†’ å–å€¼å¹¶è¿”å›
```

**è·¯å¾„B**ï¼ˆå¯èƒ½ï¼‰ï¼š
```
onReady() â†’ false
onSuspend() â†’ true  (suspend)
[wakeUp() è¢«è°ƒç”¨]
onResume() â†’ å–å€¼å¹¶è¿”å›
[ä½†åŒæ—¶ onReady() åˆè¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Ÿ]
```

**è·¯å¾„C**ï¼ˆå¯èƒ½ï¼‰ï¼š
```
onReady() â†’ false
onSuspend() â†’ true  (suspend)
onResume() â†’ å–å€¼1 å¹¶è¿”å›
[æ¶ˆè´¹è€…ç»§ç»­å¾ªç¯]
onReady() â†’ false (é˜Ÿåˆ—ç¡®å®ä¸ºç©º)
onSuspend() â†’ true (ç¬¬äºŒæ¬¡ suspend)
[ä½†æ­¤æ—¶ DequeueEvent çš„æŸä¸ªæˆå‘˜ä»ç„¶æŒæœ‰æ—§å€¼ï¼Ÿ]
```

#### é—®é¢˜ 2: Waker çš„å”¤é†’æ—¶æœº

```
Timeline:
T1: æ¶ˆè´¹è€…A æ‰§è¡Œ onReady() â†’ é˜Ÿåˆ—ç©º â†’ è¿”å›false
T2: æ¶ˆè´¹è€…A æ‰§è¡Œ onSuspend() â†’ æ·»åŠ åˆ°ç­‰å¾…åˆ—è¡¨
T3: ç”Ÿäº§è€…B å…¥é˜Ÿå€¼V1
T4: ç”Ÿäº§è€…B è°ƒç”¨ wakeWaiters() â†’ å”¤é†’æ¶ˆè´¹è€…A
T5: ä½†æ­¤æ—¶ç”Ÿäº§è€…Cä¹Ÿåœ¨è°ƒç”¨ enqueue()
T6: æ¶ˆè´¹è€…A çš„ onResume() ä½•æ—¶è°ƒç”¨ï¼Ÿ
    - ç«‹å³è°ƒç”¨ï¼Ÿ
    - åœ¨æŸä¸ªç‰¹å®šçš„ scheduler æ—¶åˆ»ï¼Ÿ
    - å€¼V1 æ˜¯å¦å·²ç»è¢«å–å‡ºï¼Ÿ
```

#### é—®é¢˜ 3: å¤šä¸ª DequeueEvent çš„äº¤äº’

```
ä¸¤ä¸ªæ¶ˆè´¹è€…ç­‰å¾…ï¼š
æ¶ˆè´¹è€…1: DequeueEvent1 (å·²suspend, ç­‰å¾…ä¸­)
æ¶ˆè´¹è€…2: DequeueEvent2 (å¯èƒ½ä¹Ÿå·²suspend, æˆ–æ­£åœ¨onReady)

ç”Ÿäº§è€…å…¥é˜Ÿï¼š
å€¼V1 â†’ è°ƒç”¨ wakeWaiters() â†’ å”¤é†’ DequeueEvent1.waker
å€¼V2 â†’ è°ƒç”¨ wakeWaiters() â†’ å”¤é†’ DequeueEvent2.waker

ä½†æ­¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿï¼š
- DequeueEvent1 çš„ onResume() æ˜¯ç«‹å³è°ƒç”¨è¿˜æ˜¯å»¶è¿Ÿè°ƒç”¨ï¼Ÿ
- åœ¨ DequeueEvent1.onResume() å’Œ DequeueEvent2.onResume() ä¹‹é—´ï¼Œ
  æ˜¯å¦æœ‰æ—¶åºçª—å£å¯¼è‡´ V1 è¢«ä¸¤ä¸ªéƒ½å–åˆ°ï¼Ÿ
```

### ç—‡çŠ¶æŒ‡å‘ AsyncEvent æ¡†æ¶é—®é¢˜

æˆ‘ä»¬è§‚å¯Ÿåˆ°çš„ç—‡çŠ¶ï¼š
- å€¼ 2000 è¢«æ¶ˆè´¹ 2 æ¬¡
- å€¼ 2001 è¢«æ¶ˆè´¹ 2 æ¬¡
- è¿™ç§è§„å¾‹æ€§æç¤ºè¿™**ä¸æ˜¯éšæœºç«æ€**ï¼Œè€Œæ˜¯**ç³»ç»Ÿæ€§çš„æ¡†æ¶è¡Œä¸º**

å¦‚æœé—®é¢˜åœ¨ AsyncQueueï¼š
- åº”è¯¥çœ‹åˆ°éšæœºçš„é‡å¤
- æŸäº›å€¼é‡å¤1æ¬¡ï¼ŒæŸäº›å€¼é‡å¤3-5æ¬¡ï¼Œåˆ†å¸ƒä¸å‡

å®é™…æƒ…å†µï¼š
- ç‰¹å®šå€¼ï¼ˆ2000, 2001, ...ï¼‰æ€»æ˜¯é‡å¤ç›¸åŒæ¬¡æ•°
- è¿™æç¤ºå¯èƒ½æ˜¯æŸä¸ª**ç‰¹å®šçš„æ‰§è¡Œè·¯å¾„**è¢«é‡å¤äº†

## ğŸ¯ æ ¹æœ¬åŸå› å‡è¯´

AsyncEvent æ¡†æ¶å¯èƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ä¹‹ä¸€ï¼š

1. **onResume() è¢«è°ƒç”¨å¤šæ¬¡**
   - æŸä¸ª DequeueEvent çš„ onResume() å¯èƒ½åœ¨ suspend/resume å¾ªç¯ä¸­è¢«è°ƒç”¨å¤šæ¬¡
   - æ¯æ¬¡éƒ½è¿”å›ç›¸åŒçš„ m_result å€¼

2. **Waker çš„å¤šæ¬¡è°ƒç”¨**
   - ä¸€ä¸ª waker å¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡
   - æ¯æ¬¡è°ƒç”¨éƒ½å¯¼è‡´ onResume() æ‰§è¡Œ

3. **AsyncEvent çŠ¶æ€ç®¡ç†ä¸å½“**
   - AsyncEvent å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹æ²¡æœ‰æ­£ç¡®æ¸…é™¤å®ŒæˆçŠ¶æ€
   - å¯¼è‡´åŒä¸€ä¸ª Event å¯¹è±¡çš„å¤„ç†é€»è¾‘è¢«é‡å¤æ‰§è¡Œ

## ğŸ”§ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: å®Œå…¨ç¦ç”¨ AsyncEvent æ¡†æ¶ï¼Œè‡ªå®ç° suspend/resume

```cpp
// ä¸ä½¿ç”¨ AsyncEventï¼Œç›´æ¥ç®¡ç† waker
AsyncResult<T> waitDequeue() {
    // è‡ªå·±æ§åˆ¶æŒ‚èµ·é€»è¾‘ï¼Œä¸ä¾èµ– AsyncEvent
}
```

### æ–¹æ¡ˆ B: åœ¨ DequeueEvent ä¸­æ·»åŠ çŠ¶æ€æ ‡å¿—

```cpp
class DequeueEvent {
private:
    bool m_resumed = false;  // æ ‡å¿—ä½ï¼šå·²ç»resumeè¿‡

    T onResume() override {
        if (m_resumed) return T();  // é˜²æ­¢å¤šæ¬¡resume
        m_resumed = true;
        // ... å–å€¼é€»è¾‘
    }
};
```

### æ–¹æ¡ˆ C: æ£€æŸ¥å¹¶ä¿®å¤ AsyncEvent æ¡†æ¶æœ¬èº«

- æŸ¥çœ‹ AsyncEvent.hpp çš„å®ç°
- ç¡®è®¤ onSuspend()/onResume() çš„è°ƒç”¨å¥‘çº¦
- ä¿®å¤ä»»ä½•å¯¼è‡´å¤šæ¬¡è°ƒç”¨çš„é—®é¢˜

## ğŸ’¡ ç»“è®º

**æ”¹è¿› AsyncQueue æœ¬èº«å¹¶ä¸èƒ½è§£å†³é—®é¢˜**ï¼Œå› ä¸ºï¼š

1. **AsyncQueue çš„å®ç°å·²ç»è¶³å¤Ÿå®‰å…¨**
   - ConcurrentQueue çº¿ç¨‹å®‰å…¨ âœ…
   - æ”¹è¿›åçš„ Waker ç®¡ç†ä½¿ç”¨ shared_ptr âœ…
   - FIFO å”¤é†’é€»è¾‘æ¸…æ™° âœ…

2. **é—®é¢˜æ ¹æºåœ¨ galay æ¡†æ¶çš„ AsyncEvent/Waker æœºåˆ¶**
   - onSuspend/onResume çš„äº¤äº’æœ‰é—®é¢˜
   - Waker çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸å½“
   - å¤šæ¶ˆè´¹è€…åœºæ™¯ä¸‹çš„çŠ¶æ€ç®¡ç†ä¸å®Œå–„

3. **ä¸‹ä¸€æ­¥éœ€è¦**
   - æ·±å…¥è°ƒæŸ¥ AsyncEvent.hpp çš„å®ç°
   - æ£€æŸ¥ Waker çš„ wakeUp() å¦‚ä½•è§¦å‘ onResume()
   - ç¡®è®¤æ˜¯å¦å­˜åœ¨é‡å¤è°ƒç”¨çš„é—®é¢˜
   - å¦‚æœç¡®è®¤æ˜¯æ¡†æ¶é—®é¢˜ï¼Œä¿®å¤æ¡†æ¶è€Œä¸æ˜¯æ”¹è¿› AsyncQueue

## ğŸ“‹ æ”¹è¿›çš„ AsyncQueue çš„ä»·å€¼

è™½ç„¶æ”¹è¿›çš„ AsyncQueue æ²¡æœ‰è§£å†³å¤šç”Ÿäº§è€…é—®é¢˜ï¼Œä½†å®ƒä»ç„¶æœ‰ä»·å€¼ï¼š

| æ”¹è¿› | ä»·å€¼ |
|------|------|
| Waker åˆ—è¡¨ | ä¸ºå°†æ¥çš„å¤šæ¶ˆè´¹è€…æ”¯æŒé“ºå¹³é“è·¯ âœ… |
| shared_ptr | æ›´å®‰å…¨çš„å†…å­˜ç®¡ç† âœ… |
| æ¸…æ™°çš„ API | addWaiter/removeWaiter æ˜“äºç†è§£ âœ… |
| ä»£ç è´¨é‡ | æ˜“äºç»´æŠ¤å’Œæµ‹è¯• âœ… |

è¿™æ˜¯ä¸€ä¸ª**é˜²å®ˆæ€§çš„æ”¹è¿›**ï¼Œä¸ºæ¡†æ¶çº§åˆ«çš„é—®é¢˜ä¿®å¤åšå‡†å¤‡ã€‚
