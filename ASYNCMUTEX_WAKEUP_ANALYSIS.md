# AsyncMutex å…³é”®é—®é¢˜åˆ†æ

## é—®é¢˜ï¼šwakeUp() ä¸å¹‚ç­‰æ˜¯å¦æœ‰é—®é¢˜ï¼Ÿ

### Waker::wakeUp() çš„å®ç°
```cpp
void Waker::wakeUp()
{
    if (!m_coroutine.expired())
    {
        auto coroutine = m_coroutine.lock();
        if (coroutine->belongScheduler() == nullptr)
        {
            throw std::runtime_error("coroutine is not running on any scheduler");
        }
        coroutine->belongScheduler()->resumeCoroutine(m_coroutine);  // åŠ å…¥å°±ç»ªé˜Ÿåˆ—
    }
}
```

åªæ˜¯è°ƒç”¨ `resumeCoroutine()`ï¼Œ**ä¸æ˜¯å¹‚ç­‰çš„** - å¦‚æœè°ƒç”¨ä¸¤æ¬¡ï¼Œåç¨‹ä¼šè¢«åŠ å…¥å°±ç»ªé˜Ÿåˆ—ä¸¤æ¬¡ã€‚

### ç¬¬ä¸€ä¸ªç›´è§‰ï¼šéœ€è¦å¹‚ç­‰å—ï¼Ÿ

**çŸ­ç­”æ¡ˆï¼šåœ¨ç†è®ºä¸Šï¼ŒAsyncMutex çš„å½“å‰è®¾è®¡ä¸­ï¼Œä¸åº”è¯¥å‡ºç°åŒä¸€ä¸ª Waker è¢« wakeUp å¤šæ¬¡çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸éœ€è¦å¹‚ç­‰ã€‚**

è®©æˆ‘ä»¬éªŒè¯è¿™ä¸ªå‡è®¾ï¼š

## å…³é”®ä»£ç è·¯å¾„åˆ†æ

### onSuspend ä¸­çš„ Double-Check é€»è¾‘

```cpp
bool LockEvent::onSuspend(Waker waker)
{
    // Step 1: å…¥é˜Ÿ
    {
        std::lock_guard<std::mutex> guard(m_mutex.m_queue_mutex);
        m_mutex.m_waiters.push(waker);
    }

    // Step 2: Double-Check
    if (m_mutex.tryLock())
    {
        // æˆåŠŸè·å–é”ï¼
        std::lock_guard<std::mutex> guard(m_mutex.m_queue_mutex);
        if (!m_mutex.m_waiters.empty())
        {
            m_mutex.m_waiters.pop();  // âš ï¸ è¿™é‡Œæ˜¯å…³é”®ï¼
        }
        return false;  // ä¸æš‚åœ
    }

    // å¤±è´¥ï¼Œæš‚åœ
    return true;
}
```

## ğŸ”´ æˆ‘å‘ç°çš„çœŸæ­£é—®é¢˜ï¼špop() é€»è¾‘é”™è¯¯ï¼

ä¸æ˜¯ wakeUp çš„å¹‚ç­‰æ€§é—®é¢˜ï¼Œè€Œæ˜¯ **pop() å‡è®¾é˜Ÿåˆ—é¦–å…ƒç´ å°±æ˜¯å½“å‰åç¨‹ï¼Œè¿™ä¸ªå‡è®¾åœ¨å¤šåç¨‹ç«äº‰æ—¶**ä¸æˆç«‹ï¼

### é—®é¢˜åœºæ™¯

```
æ—¶é—´    åç¨‹A (onSuspend)              åç¨‹B (onSuspend)
t1      push(A) -> [A]
t2      tryLock() = å¤±è´¥

t3                                     push(B) -> [A, B]
t4                                     tryLock() = æˆåŠŸï¼âœ“
                                       lock(queue_mutex)
                                       if (!empty) pop()  <- pop(A)!!! âŒ
                                       unlock(queue_mutex)
                                       return false (ä¸æš‚åœ)

t5      return true (æš‚åœ)             [B]

ç»“æœï¼š
- åç¨‹B è·å¾—äº†é”ï¼Œä½†...
- pop() ç§»é™¤çš„æ˜¯ Aï¼ˆé¦–å…ƒç´ ï¼‰ï¼Œä¸æ˜¯ B
- åç¨‹A æš‚åœï¼Œä»ç„¶åœ¨é˜Ÿåˆ—ä¸­...ç­‰ç­‰ï¼Œä¸å¯¹ï¼

è®©æˆ‘é‡æ–°çœ‹ï¼š
```

å®é™…ä¸Šè®©æˆ‘å†æƒ³æƒ³...å¦‚æœ B tryLock æˆåŠŸï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

```
tryLock() çš„é€»è¾‘ï¼š
  compare_exchange_strong(expected=0, new=1)

  å¦‚æœ m_locked == 0ï¼Œè®¾ç½®ä¸º 1ï¼Œè¿”å› true
  å¦åˆ™è¿”å› false
```

æ‰€ä»¥ï¼š
- åç¨‹A tryLock = å¤±è´¥ï¼Œè¯´æ˜ m_locked = 1ï¼ˆè¢«æŸä¸ªçº¿ç¨‹æŒæœ‰ï¼‰
- åç¨‹B tryLock = æˆåŠŸï¼Œè¯´æ˜ m_locked = 0ï¼Œç„¶å B å°†å…¶è®¾ä¸º 1

ä½†è¿™é‡Œæ²¡æœ‰å¤šçº¿ç¨‹å•Šï¼ŒAsyncMutex æ˜¯ä¸ºåç¨‹çš„ï¼

### ç­‰ç­‰ï¼Œè¿™ä¸å¯èƒ½å‘ç”Ÿ

åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆå•ä¸€è°ƒåº¦å™¨ï¼‰ä¸­ï¼š
```
åç¨‹A å’Œ B è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹
åç¨‹A: t1-t5 æ˜¯ä¸€ä¸ªè¿ç»­çš„ä»£ç æ®µï¼Œä¸ä¼šè¢«ä¸­æ–­
ç›´åˆ° await_suspend æ‰ä¼šæš‚åœ

æ‰€ä»¥ä¸å¯èƒ½åœ¨ A çš„ tryLock å’Œ B çš„ push ä¹‹é—´åˆ‡æ¢
```

**å…³é”®è®¤è¯†**ï¼šAsyncMutex æ˜¯ä¸ºåç¨‹è®¾è®¡çš„ï¼Œåç¨‹åœ¨ co_await æ—¶æ‰ä¼šæš‚åœã€‚

åœ¨ onSuspend ä¸­ï¼Œåç¨‹æ˜¯**ä¸ä¼šæš‚åœçš„**ã€‚æ‰€ä»¥ä¸å¯èƒ½æœ‰ä¸¤ä¸ªåç¨‹åŒæ—¶åœ¨ onSuspend ä¸­ã€‚

### é‚£ä¹ˆçœŸæ­£çš„é—®é¢˜åœ¨å“ªé‡Œï¼Ÿ

å®é™…çš„ç«äº‰çª—å£æ˜¯è¿™æ ·çš„ï¼š

```
åç¨‹A: onSuspend
  push(A) -> [A]
  tryLock = å¤±è´¥
  return true
  (await è¿”å›ï¼Œåç¨‹æš‚åœ)

[æ­¤æ—¶è°ƒåº¦å™¨å¯èƒ½è¿è¡Œå…¶ä»–åç¨‹]

åç¨‹B: unlock()
  store(0, release)
  wakeupNext() {
    lock(queue_mutex)
    pop(A) -> []
    tryLock() = æˆåŠŸ
    A.wakeUp()  <- å”¤é†’åç¨‹A
    return
  }

[è°ƒåº¦å™¨ç¨åè¿è¡Œåç¨‹A]
åç¨‹A: ç»§ç»­æ‰§è¡Œ (ä» co_await è¿”å›)
  await_suspend æ ‡è®° Suspended
  await_resume()  < åç¨‹A æ­£å¼è·å¾—é”

ç„¶åï¼š
åç¨‹A: æ‰§è¡Œä¸´ç•ŒåŒºä»£ç 

åç¨‹A: unlock()
  å”¤é†’ä¸‹ä¸€ä¸ªåç¨‹...
```

åœ¨è¿™ä¸ªæ­£å¸¸æµç¨‹ä¸­ï¼ŒwakeUp åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸éœ€è¦å¹‚ç­‰ã€‚

## ğŸ¤” ä½†æœ‰æ²¡æœ‰å¯èƒ½å¤šæ¬¡è°ƒç”¨ wakeUpï¼Ÿ

å…³é”®é—®é¢˜ï¼š**åœ¨ onSuspend ä¸­ï¼Œå½“ Double-Check tryLock æˆåŠŸæ—¶ï¼Œæˆ‘ä»¬ pop() äº†é˜Ÿåˆ—é¦–å…ƒç´ ã€‚ä½†è¿™ä¸ªé¦–å…ƒç´ çœŸçš„æ˜¯å½“å‰åç¨‹å—ï¼Ÿ**

ç­”æ¡ˆï¼š**åœ¨å•åç¨‹å…¥é˜Ÿåœºæ™¯ä¸‹æ˜¯çš„ï¼Œä½†ç†è®ºä¸Šæœ‰æ¼æ´**ã€‚

### ç†è®ºä¸Šçš„æ¼æ´

å¦‚æœé˜Ÿåˆ—å®ç°æœ‰é—®é¢˜ï¼Œæˆ–è€…æœ‰å…¶ä»–åœ°æ–¹ä¹Ÿåœ¨ä¿®æ”¹é˜Ÿåˆ—ï¼Œé‚£ä¹ˆï¼š
```
åç¨‹A: push(A) -> [A]
       tryLock = å¤±è´¥

[æœ‰äººä»å¤–éƒ¨ pop(A)]  <- ä¸åº”è¯¥å‘ç”Ÿ

åç¨‹A: return true (æš‚åœ)
       ä½†å·²ç»ä¸åœ¨é˜Ÿåˆ—ä¸­äº†ï¼
       è°æ¥å”¤é†’ Aï¼Ÿæ— äººï¼
       æ­»é”ï¼
```

## çœŸæ­£çš„å®‰å…¨é—®é¢˜

ä¸æ˜¯"wakeUp éœ€è¦å¹‚ç­‰"ï¼Œè€Œæ˜¯ï¼š

1. **pop() å‡è®¾é¦–å…ƒç´ å°±æ˜¯è‡ªå·±** - è¿™åœ¨å¤šç”Ÿäº§è€…åœºæ™¯ä¸‹ä¸å®‰å…¨

2. **wakeUp åæ‰æš‚åœçš„æ—¶åº** - å¦‚æœ wakeUp åœ¨ return true å‰è¢«è°ƒç”¨ï¼Œåç¨‹ä¼šåŒæ—¶åœ¨å°±ç»ªé˜Ÿåˆ—å’Œæš‚åœçŠ¶æ€

3. **åç¨‹é”€æ¯æ—¶ Waker ä»æœ‰æ•ˆ**ï¼Ÿ

## è¯„ä»·

### wakeUp ä¸å¹‚ç­‰æœ¬èº«ä¸æ˜¯é—®é¢˜
å› ä¸ºåœ¨æ­£å¸¸æµç¨‹ä¸­ï¼Œæ¯ä¸ª Waker æœ€å¤šè¢« wakeUp() ä¸€æ¬¡ã€‚

### ä½†å¦‚æœè¦æ±‚å¹‚ç­‰ï¼Œèƒ½æ›´å®‰å…¨å—ï¼Ÿ

**å¯ä»¥å¢å¼ºå®‰å…¨æ€§**ï¼š
```cpp
void Waker::wakeUp()
{
    if (!m_coroutine.expired())
    {
        auto coroutine = m_coroutine.lock();
        if (coroutine->status != Ready) {  // æ£€æŸ¥çŠ¶æ€ï¼Œé¿å…é‡å¤
            coroutine->status = Ready;
            coroutine->belongScheduler()->resumeCoroutine(m_coroutine);
        }
    }
}
```

è¿™æ ·å³ä½¿è°ƒç”¨å¤šæ¬¡ä¹Ÿåªä¼šç”Ÿæ•ˆä¸€æ¬¡ï¼Œæ›´ç¨³å¥ã€‚

ä½†è¿™ä¾èµ–äº Coroutine æœ‰ä¸ª status å­—æ®µå¹¶ä¸”æ˜¯åŸå­çš„ã€‚

## æœ€ç»ˆç»“è®º

- **å½“å‰è®¾è®¡**ï¼šä¸éœ€è¦å¹‚ç­‰ï¼Œå› ä¸ºè®¾è®¡ä¸Šæ¯ä¸ª Waker æœ€å¤šè°ƒç”¨ä¸€æ¬¡
- **ä½†ä»é˜²å¾¡æ€§ç¼–ç¨‹è§’åº¦**ï¼šæœ€å¥½è®© wakeUp() å¹‚ç­‰ï¼Œæ›´å®‰å…¨
- **çœŸæ­£çš„é£é™©**ï¼šä¸åœ¨å¹‚ç­‰æ€§ï¼Œè€Œåœ¨ onSuspend çš„ pop é€»è¾‘å’Œæ—¶åºç®¡ç†

