# Galay TCP 压力测试工具

## 简介

本目录包含基于Galay框架的TCP服务器压力测试工具，包括服务端和客户端。

## 文件说明

- `stress_tcp_server.cc` - 压力测试服务器，提供echo服务和实时统计
- `stress_tcp_client.cc` - 压力测试客户端，支持多并发和自定义参数
- `CMakeLists.txt` - 构建配置文件
- `README.md` - 本文档

## 编译

在项目根目录的build目录中编译：

```bash
cd build
cmake ..
make
```

编译完成后，可执行文件位于 `build/benchmark/` 目录。

## 使用方法

### 1. 启动压测服务器

```bash
./stress_tcp_server [端口] [backlog大小]
```

参数说明：
- `端口` - 监听端口，默认8070
- `backlog大小` - TCP backlog大小，默认2048

示例：
```bash
# 使用默认参数（监听8070端口）
./stress_tcp_server

# 指定端口和backlog
./stress_tcp_server 9000 4096
```

服务器功能：
- 自动echo客户端发送的所有数据
- **支持控制命令**：接收 `start` 命令开始统计，接收 `finish` 命令结束并输出报告
- 每5秒打印一次实时统计信息
- Ctrl+C时打印最终统计并退出

### 2. 运行压测客户端

```bash
./stress_tcp_client [服务器IP] [端口] [并发数] [每客户端请求数] [消息大小]
```

参数说明：
- `服务器IP` - 服务器地址，默认127.0.0.1
- `端口` - 服务器端口，默认8070
- `并发数` - 并发客户端数量，默认100
- `每客户端请求数` - 每个客户端发送的请求数，默认1000
- `消息大小` - 每个消息的字节数，默认1024

示例：
```bash
# 使用默认参数（100并发，每个1000请求，1KB消息）
./stress_tcp_client

# 自定义参数（1000并发，每个500请求，2KB消息）
./stress_tcp_client 127.0.0.1 8070 1000 500 2048

# 轻量级测试
./stress_tcp_client 127.0.0.1 8070 10 100 512
```

客户端功能：
- **自动发送控制命令**：测试前自动发送 `start` 到服务器，测试后发送 `finish`
- 多并发客户端同时发送随机消息
- 实时记录延迟和吞吐量
- 测试完成后输出详细报告

## 测试场景

### 场景1：基准性能测试
```bash
# 服务器
./stress_tcp_server 8070

# 客户端（100并发，10万请求，1KB消息）
./stress_tcp_client 127.0.0.1 8070 100 1000 1024
```

### 场景2：高并发测试
```bash
# 服务器（更大的backlog）
./stress_tcp_server 8070 4096

# 客户端（1000并发）
./stress_tcp_client 127.0.0.1 8070 1000 500 1024
```

### 场景3：大消息测试
```bash
# 服务器
./stress_tcp_server 8070

# 客户端（64KB消息）
./stress_tcp_client 127.0.0.1 8070 100 1000 65536
```

### 场景4：持久连接测试
```bash
# 服务器
./stress_tcp_server 8070

# 客户端（少并发，多请求）
./stress_tcp_client 127.0.0.1 8070 10 10000 1024
```

## 性能指标

客户端测试完成后会显示：
- **QPS** - 每秒请求数
- **吞吐量** - 发送/接收速率（MB/s）
- **平均延迟** - 单个请求的平均响应时间（ms）
- **成功率** - 请求成功百分比

服务器会实时显示：
- 总连接数、活跃连接数
- 总请求数
- 接收/发送字节数
- QPS和吞吐量

## 注意事项

1. **系统资源限制**
   - 高并发测试可能需要调整系统文件描述符限制：
     ```bash
     ulimit -n 65535
     ```

2. **网络配置**
   - 本地测试使用127.0.0.1
   - 跨机器测试确保网络连通性和防火墙配置

3. **性能建议**
   - 服务器和客户端最好运行在不同的CPU核心或机器上
   - 避免在单核机器上进行高并发测试
   - 根据实际硬件调整并发数和消息大小

4. **测试时长**
   - 总请求数 = 并发数 × 每客户端请求数
   - 建议从小规模开始，逐步增加负载

## 故障排查

### 连接失败
- 检查服务器是否正常运行
- 确认端口号是否正确
- 检查防火墙设置

### 性能不达预期
- 检查CPU和内存使用率
- 调整并发数和消息大小
- 增加服务器的backlog大小
- 检查网络带宽

### 大量错误
- 减少并发数
- 增加服务器资源
- 检查系统日志

## 扩展

可以基于这些工具进行扩展：
- 添加不同的消息模式（固定、随机、递增）
- 支持不同的测试模式（突发流量、渐增负载）
- 添加更详细的性能分析（P50/P99延迟）
- 集成监控和可视化

## 示例输出

### 服务器输出
```
========== TCP压力测试服务器 ==========
监听地址: 0.0.0.0:8070
Backlog: 2048
======================================

========== 服务器统计 ==========
等待客户端发送 'start' 命令开始统计...
总连接数: 0
活跃连接: 0
==============================

[控制] 收到start命令，开始统计...

========== 服务器实时统计 ==========
总连接数: 100
活跃连接: 50
总请求数: 50000
接收字节: 48.83 MB
发送字节: 48.83 MB

性能指标:
  测试时长: 5.123 秒
  QPS: 9760 请求/秒
  吞吐量: 9.53 MB/s
==============================

[控制] 收到finish命令，结束统计...

========== 服务器最终统计 ==========
总连接数: 100
活跃连接: 0
总请求数: 100000
接收字节: 97.66 MB
发送字节: 97.66 MB

性能指标:
  测试时长: 10.234 秒
  QPS: 9771 请求/秒
  吞吐量: 9.54 MB/s

✓ 压测完成！
==============================
```

### 客户端输出
```
========== TCP客户端压力测试 ==========
服务器: 127.0.0.1:8070
并发客户端: 100
每客户端请求: 1000
消息大小: 1024 字节
总请求数: 100000
======================================

按回车开始测试...
使用 8 个运行时

发送start命令到服务器...
✓ 服务器确认: started
开始压力测试...

客户端 0 完成 100 个请求
客户端 0 完成测试
客户端 10 完成测试
...

所有客户端测试完成！
发送finish命令到服务器...
✓ 服务器确认: finished

========== 压力测试结果 ==========
测试配置:
  服务器: 127.0.0.1:8070
  并发客户端: 100
  每客户端请求: 1000
  消息大小: 1024 字节

性能指标:
  总请求数: 100000
  成功响应: 100000
  失败数: 0
  成功率: 100.00%
  测试时间: 10.25 秒

吞吐量:
  QPS: 9756 请求/秒
  发送: 9.53 MB/s
  接收: 9.53 MB/s

延迟:
  平均延迟: 1.02 ms
================================
```

